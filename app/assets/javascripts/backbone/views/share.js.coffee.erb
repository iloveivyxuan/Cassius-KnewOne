Making.Views.Share = Backbone.View.extend

  el: '.tiny_share'

  events:
    'mouseenter .weixin': 'weixin'
    'mouseleave .weixin': 'weixin'
    'click .weixin': 'prevent_default'
    'click .weibo': 'weibo'
    'click .twitter': 'twitter'

  initialize: ->
    @$weixin = @$('.weixin')
    @$weixin.popover
      html: true
      content: $('<div />').qrcode
        render: 'image'
        ecLevel: 'L'
        text: if document.URL.indexOf('#') > 0 then Making.url else document.URL

  prevent_default: (event) ->
    event.preventDefault()

  weixin: (event) ->
    @$weixin.popover if event.type is 'mouseenter' then 'show' else 'hide'

  weibo: (event) ->
    event.preventDefault()

    content = $('meta[name="sharing_content"]').attr('content')
    if content == undefined or content.length == 0 then content = document.title + ' ' + location.href

    pic = $('.sharing_cover').attr('src')
    if pic == undefined then pic = ''

    window.open 'http://v.t.sina.com.cn/share/share.php?appkey=<%= Settings.weibo.consumer_key %>&title=' + encodeURIComponent(content) + '&url=' + encodeURIComponent(location.href) + '&pic=' + encodeURIComponent(pic) + '&source=bookmark' + '&content=utf-8', '_blank', 'width=500,height=500'

  twitter: (event) ->
    event.preventDefault()
    content = $('meta[name="sharing_content"]').attr('content')
    if content == undefined or content.length == 0 then content = document.title
    window.open 'http://twitter.com/share?text=' + content  + '&url='+ encodeURIComponent(location.href) + '&amp;source=bookmark', '_blank', 'width=500,height=500'
